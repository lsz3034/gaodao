<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>易经查询</title>
    <link href="/static/layui/css/layui.css" rel="stylesheet">
    <style>
        .centered-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f2f2f2;
            padding: 20px;
        }
        
        .form-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .form-card.collapsed {
            padding: 15px;
            max-width: 200px;
            cursor: pointer;
        }
        
        .form-card.collapsed .layui-form {
            display: none;
        }
        
        .content-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            display: none;
        }
        
        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 24px;
            color: #333;
        }
        
        .divination-btn {
            margin-left: 15px;
            padding: 4px 10px;
            font-size: 14px;
            background: #009688;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .divination-btn:hover {
            background: #00877a;
        }
        
        .divination-content {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, #f5f5f5 0%, #fff 100%);
        }
        
        .divination-steps {
            margin: 20px auto 30px;
            max-width: 280px;
            text-align: left;
        }
        
        .divination-steps p {
            position: relative;
            padding: 15px 15px 15px 35px;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            color: #333;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .divination-steps p:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .divination-steps p:before {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #009688;
            border-radius: 50%;
        }
        
        .generate-btn {
            background: linear-gradient(145deg, #009688, #00796b);
            color: white;
            padding: 12px 35px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,150,136,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,150,136,0.3);
        }
        
        .generate-btn:active {
            transform: translateY(1px);
        }
        
        .generate-btn.generating {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .generate-btn.generating:after {
            content: '';
            position: absolute;
            width: 30px;
            height: 300px;
            background: rgba(255,255,255,0.3);
            animation: sweep 1s infinite;
            transform: rotate(45deg);
        }
        
        .search-btn {
            background: #009688;
            color: white;
            border: none;
            padding: 10px 40px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,150,136,0.2);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 45px;
        }
        
        .search-btn:hover {
            background: #00877a;
            box-shadow: 0 4px 8px rgba(0,150,136,0.3);
            transform: translateY(-1px);
        }
        
        .layui-input-wrap {
            width: 100%;
        }
        
        .hexagram-title {
            font-size: 28px;
            color: #009688;
            display: inline-block;
        }
        
        .changing-line {
            font-size: 18px;
            color: #666;
            display: inline-block;
            margin-left: 15px;
        }
        
        .content-text {
            line-height: 1.8;
            color: #333;
        }
        
        @keyframes sweep {
            0% { left: -100%; }
            100% { left: 200%; }
        }
        
        .layui-layer {
            border-radius: 12px !important;
        }
        
        .layui-layer-title {
            background: #009688 !important;
            color: white !important;
            border-radius: 12px 12px 0 0 !important;
            text-align: center;
            font-size: 18px !important;
            height: 50px !important;
            line-height: 50px !important;
        }
    </style>
</head>
<body>
    <div class="centered-container">
        <div class="form-card" id="formCard" onclick="expandForm(event)">
            <div class="title-container">
                <div class="title">卦象查询</div>
                <button class="divination-btn" onclick="showDivination()">摇卦</button>
            </div>
            <div class="collapsed-title">点击展开查询</div>
            <div class="layui-form">
                <div class="layui-form-item">
                    <div class="layui-input-wrap">
                        <div class="layui-input-prefix">
                            <i class="layui-icon layui-icon-up"></i>
                        </div>
                        <input type="number" id="upperNumber" 
                               lay-verify="required|upper" 
                               placeholder="请输入上爻(1-8)" 
                               lay-reqtext="请输入上爻" 
                               min="1" max="8"
                               oninput="validateNumber(this, 1, 8)"
                               autocomplete="off" class="layui-input" lay-affix="clear">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-wrap">
                        <div class="layui-input-prefix">
                            <i class="layui-icon layui-icon-down"></i>
                        </div>
                        <input type="number" id="lowerTrigram" 
                               lay-verify="required|lower" 
                               placeholder="请输入下爻(1-8)" 
                               lay-reqtext="请输入下爻" 
                               min="1" max="8"
                               oninput="validateNumber(this, 1, 8)"
                               autocomplete="off" class="layui-input" lay-affix="clear">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-wrap">
                        <div class="layui-input-prefix">
                            <i class="layui-icon layui-icon-edit"></i>
                        </div>
                        <input type="number" id="changingLine" 
                               lay-verify="changing" 
                               placeholder="请输入变爻(1-6)" 
                               min="1" max="6"
                               oninput="validateNumber(this, 1, 6)"
                               autocomplete="off" class="layui-input" lay-affix="clear">
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-left: 0;">
                        <button class="search-btn" onclick="findHexagram(event)">查询卦象</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="result" class="content-card">
            <div class="title-container">
                <span class="hexagram-title" id="hexagramName"></span>
                <span class="changing-line" id="changingLineText"></span>
            </div>
            <div id="contentDisplay" class="content-text"></div>
        </div>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['jquery', 'layer', 'form'], function(){
            var $ = layui.jquery;
            var layer = layui.layer;
            var form = layui.form;
            window.$ = $;
            window.hexagramData = [];
            $.ajax({
                url: '/static/json/list.json',
                type: 'GET',
                dataType: 'json',
                success: function(res) {
                    window.hexagramData = res;
                },
                error: function(xhr) {
                    layer.msg('加载数据失败');
                }
            });
            // 自定义验证规则
            form.verify({
                upper: function(value, item) {
                    if (value && (value < 1 || value > 8)) {
                        return '上爻数值必须在1-8之间';
                    }
                },
                lower: function(value, item) {
                    if (value && (value < 1 || value > 8)) {
                        return '下爻数值必须在1-8之间';
                    }
                },
                changing: function(value, item) {
                    if (value && (value < 1 || value > 6)) {
                        return '变爻数值必须在1-6之间';
                    }
                }
            });
        });
        
        function validateNumber(input, min, max) {
            input.value = input.value.replace(/[^\d]/g, '');
            
            let num = parseInt(input.value);
            if (num < min || num > max) {
                layer.tips(`请输入${min}-${max}之间的数字`, input, {
                    tips: [1, '#FF5722'],
                    time: 2000
                });
            }
            
            if (num < min) {
                input.value = min;
            }
            if (num > max) {
                input.value = max;
            }
        }

        function expandForm(event) {
            if (event.target.id === 'formCard' || event.target.className === 'collapsed-title') {
                document.getElementById('formCard').classList.remove('collapsed');
            }
        }

        function showDivination() {
            layer.open({
                type: 1,
                title: '神圣的占卦',
                area: ['400px', '400px'],
                skin: 'layui-layer-rim',
                content: `
                    <div class="divination-content">
                        <div class="divination-steps">
                            <p>心中默想自己所求的事</p>
                            <p>屏气凝神</p>
                            <p>在间不容发之际点击下方按钮</p>
                        </div>
                        <button class="generate-btn" onclick="generateNumbers(this)">点击摇卦</button>
                    </div>
                `
            });
        }

        function generateNumbers(btn) {
            btn.classList.add('generating');
            btn.innerText = '卦象生成中...';

            setTimeout(function() {
                var upperNumber = Math.floor(Math.random() * 8) + 1;
                var lowerTrigram = Math.floor(Math.random() * 8) + 1;
                var changingLine = Math.floor(Math.random() * 6) + 1;

                document.getElementById('upperNumber').value = upperNumber;
                document.getElementById('lowerTrigram').value = lowerTrigram;
                document.getElementById('changingLine').value = changingLine;

                layer.closeAll();
                findHexagram(new Event('click'));
            }, 1000);
        }

        function findHexagram(event) {
            event.stopPropagation();
            var upperNumber = parseInt(document.getElementById('upperNumber').value);
            var lowerTrigram = parseInt(document.getElementById('lowerTrigram').value);
            var changingLine = parseInt(document.getElementById('changingLine').value);

            if (!upperNumber || !lowerTrigram) {
                layer.msg('请输入上爻和下爻');
                return;
            }

            var matchingHexagram = window.hexagramData.find(function(h) {
                return h.upper_number === upperNumber && h.lower_trigram === lowerTrigram;
            });

            if (matchingHexagram) {
                document.getElementById('hexagramName').innerText = matchingHexagram.hexagram_name;
                document.getElementById('changingLineText').innerText = changingLine ? `第 ${changingLine} 爻变` : '';
                document.getElementById('result').style.display = 'block';
                document.getElementById('formCard').classList.add('collapsed');
                
                $.ajax({
                    url: '/' + matchingHexagram.jsname,
                    type: 'GET',
                    dataType: 'json',
                    success: function(res) {
                        if (res && res.content) {
                            document.getElementById('contentDisplay').innerHTML = res.content;
                        } else {
                            layer.msg('获取详细内容失败');
                        }
                    },
                    error: function(xhr) {
                        layer.msg('加载详细内容失败');
                    }
                });
            } else {
                layer.msg('未找到对应的卦象');
            }
        }
    </script>
</body>
</html>